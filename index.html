<script>
    // ==================== WebSocket管理器 ====================
    class WebSocketManager {
        constructor() {
            this.ws = null;
            this.ip = localStorage.getItem('pc-server-ip') || '';
            this.port = '8080';
            this.connected = false;
            this.reconnectAttempts = 0;
            this.maxReconnectAttempts = 5;
            this.messageHandlers = new Map();
            
            this.init();
        }

        init() {
            this.registerHandler('connected', (data) => {
                this.showToast(`✅ 已连接到电脑 (${data.screen.width}x${data.screen.height})`, '#00ffaa');
                this.updateControls(true);
            });

            this.registerHandler('error', (data) => {
                this.showToast(`❌ ${data.message}`, '#ff5e6b');
            });

            this.registerHandler('pong', () => {});

            if (this.ip) {
                setTimeout(() => this.connect(), 1000);
            }
        }

        connect() {
            if (!this.ip) {
                this.showToast('请先设置IP地址', '#ffaa00');
                return;
            }

            const wsUrl = `ws://${this.ip}:${this.port}`;
            this.updateStatus('connecting', '连接中...', '#ffaa00');
            
            try {
                this.ws = new WebSocket(wsUrl);
                
                this.ws.onopen = () => {
                    this.connected = true;
                    this.reconnectAttempts = 0;
                    this.updateStatus('connected', `已连接 (${this.ip})`, '#1effb0');
                    this.showToast('✅ 连接成功', '#00ffaa');
                    this.updateControls(true);
                    this.startHeartbeat();
                };
                
                this.ws.onmessage = (event) => {
                    try {
                        const data = JSON.parse(event.data);
                        this.handleMessage(data);
                    } catch (e) {}
                };
                
                this.ws.onclose = () => {
                    this.connected = false;
                    this.updateStatus('disconnected', '已断开', '#ff5e6b');
                    this.updateControls(false);
                    
                    if (this.reconnectAttempts < this.maxReconnectAttempts) {
                        this.reconnectAttempts++;
                        const delay = 2000 * this.reconnectAttempts;
                        this.updateStatus('reconnecting', `重连中 (${this.reconnectAttempts}/${this.maxReconnectAttempts})`, '#ffaa00');
                        setTimeout(() => this.connect(), delay);
                    } else {
                        this.showToast('❌ 重连失败，请手动重连', '#ff5e6b');
                    }
                };
                
                this.ws.onerror = (error) => {
                    this.showToast('⚠️ 连接错误', '#ffaa00');
                };
                
            } catch (error) {
                this.showToast('❌ 连接失败', '#ff5e6b');
            }
        }

        disconnect() {
            if (this.ws) {
                this.ws.close();
                this.ws = null;
                this.connected = false;
                this.updateStatus('disconnected', '已断开', '#ff5e6b');
                this.updateControls(false);
            }
        }

        send(type, data = {}) {
            if (!this.connected || !this.ws || this.ws.readyState !== WebSocket.OPEN) {
                this.showToast('⚠️ 未连接到电脑', '#ffaa00');
                return false;
            }
            const message = { type, ...data, timestamp: Date.now() };
            try {
                this.ws.send(JSON.stringify(message));
                return true;
            } catch (error) {
                return false;
            }
        }

        registerHandler(type, handler) {
            this.messageHandlers.set(type, handler);
        }

        handleMessage(data) {
            const handler = this.messageHandlers.get(data.type);
            if (handler) handler(data);
        }

        startHeartbeat() {
            setInterval(() => {
                if (this.connected) this.send('ping');
            }, 30000);
        }

        updateStatus(status, text, color) {
            const led = document.getElementById('statusLed');
            const statusText = document.getElementById('statusText');
            const ipDisplay = document.getElementById('ipDisplay');
            
            led.style.background = color;
            led.style.boxShadow = `0 0 20px ${color}`;
            statusText.textContent = text;
            if (this.ip) ipDisplay.textContent = this.ip;
        }

        updateControls(enabled) {
            document.querySelectorAll('.btn-mouse, .key, .macro-btn').forEach(el => {
                el.classList.toggle('disabled', !enabled);
            });
        }

        showToast(message, color) {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.style.background = color + '20';
            toast.style.borderColor = color;
            toast.style.color = color;
            toast.style.opacity = '1';
            setTimeout(() => toast.style.opacity = '0', 2000);
        }

        setIp(ip) {
            this.ip = ip;
            localStorage.setItem('pc-server-ip', ip);
            document.getElementById('ipDisplay').textContent = ip;
            this.disconnect();
            setTimeout(() => this.connect(), 500);
        }
    }

    // ==================== 初始化 ====================
    let wsManager;
    
    document.addEventListener('DOMContentLoaded', () => {
        wsManager = new WebSocketManager();
        
        const cursor = document.getElementById('remoteCursor');
        const liveScreen = document.getElementById('liveScreen');
        const touchpad = document.getElementById('touchpadSurface');
        const hint = document.getElementById('touchpadHint');

        // 触屏直接移动鼠标（点哪去哪）
        function setCursor(x, y) {
            cursor.style.left = x + 'px';
            cursor.style.top = y + 'px';
        }

        // 触屏点击 = 直接移动鼠标
        touchpad.addEventListener('touchstart', (e) => {
            e.preventDefault();
            const touch = e.touches[0];
            const rect = touchpad.getBoundingClientRect();
            const px = touch.clientX - rect.left;
            const py = touch.clientY - rect.top;

            // 相对触控板比例
            const rx = px / rect.width;
            const ry = py / rect.height;

            // 发送绝对移动
            wsManager.send('mouse-move-absolute', { rx, ry });
            setCursor(px, py);
            hint.textContent = '已移动';
        });

        touchpad.addEventListener('touchend', () => {
            hint.textContent = '点哪鼠标去哪';
        });

        // 鼠标左右键
        document.getElementById('leftClickBtn').addEventListener('touchstart', (e) => {
            e.preventDefault();
            wsManager.send('mouse-down', { button: 'left' });
        });
        document.getElementById('leftClickBtn').addEventListener('touchend', (e) => {
            e.preventDefault();
            wsManager.send('mouse-up', { button: 'left' });
        });

        document.getElementById('rightClickBtn').addEventListener('touchstart', (e) => {
            e.preventDefault();
            wsManager.send('mouse-down', { button: 'right' });
        });
        document.getElementById('rightClickBtn').addEventListener('touchend', (e) => {
            e.preventDefault();
            wsManager.send('mouse-up', { button: 'right' });
        });

        // 键盘
        document.querySelectorAll('.key').forEach(key => {
            key.addEventListener('touchstart', (e) => {
                e.preventDefault();
                const k = key.dataset.key;
                wsManager.send('key-down', { key: k });
                key.style.transform = 'translateY(6px)';
            });
            key.addEventListener('touchend', (e) => {
                e.preventDefault();
                const k = key.dataset.key;
                wsManager.send('key-up', { key: k });
                key.style.transform = '';
            });
        });

        // 宏
        document.getElementById('screenshotBtn').onclick = () => wsManager.send('screenshot');
        document.getElementById('lockBtn').onclick = () => wsManager.send('lock');
        document.getElementById('shutdownBtn').onclick = () => {
            if (confirm('确定关机？')) wsManager.send('shutdown');
        };

        // 设置
        document.getElementById('settingsBtn').onclick = () => {
            document.getElementById('ipModal').style.display = 'flex';
            document.getElementById('ipInput').value = wsManager.ip || '';
        };
        document.getElementById('reconnectBtn').onclick = () => {
            wsManager.disconnect();
            setTimeout(() => wsManager.connect(), 1000);
        };
        document.getElementById('saveIpBtn').onclick = () => {
            const ip = document.getElementById('ipInput').value.trim();
            if (ip) {
                wsManager.setIp(ip);
                document.getElementById('ipModal').style.display = 'none';
            }
        };
        document.getElementById('cancelIpBtn').onclick = () => {
            document.getElementById('ipModal').style.display = 'none';
        };
    });
</script>
